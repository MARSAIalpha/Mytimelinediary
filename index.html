<!DOCTYPE html>
<html lang="zh-CN" class="overflow-x-hidden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#E0F7FA">
    <title>Timeline: Fortune Teller</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Ma+Shan+Zheng&family=Lato:wght@400;700&family=Oswald:wght@300;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- Core Config --- */
        :root { --transition-speed: 3s; }
        body { font-family: 'Cormorant Garamond', serif; -webkit-font-smoothing: antialiased; width: 100%; overflow-x: hidden; margin: 0; }
        .font-display { font-family: 'Cinzel', serif; }
        .font-num { font-family: 'Lato', sans-serif; letter-spacing: 0.02em; }
        .font-cn { font-family: 'Ma Shan Zheng', cursive; } /* Chinese Art Font */
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* --- Themes --- */
        
        /* ‚òÄÔ∏è Day */
        body[data-theme="day"] {
            --bg-grad: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%);
            --text: #2C3E50; --text-sec: #607D8B; --primary: #F39C12; --line: #BDC3C7;
            --card-bg: rgba(255, 255, 255, 0.85);
            --sun-pos: 10%; --moon-pos: 150%; 
            --sun-opacity: 1; --moon-opacity: 0;
        }

        /* üåÖ Dawn */
        body[data-theme="dawn"] {
            --bg-grad: linear-gradient(180deg, #FF9A9E 0%, #FECFEF 50%, #E0C3FC 100%);
            --text: #4A4E69; --text-sec: #9A8C98; --primary: #FF6B6B; --line: #C9ADA7;
            --card-bg: rgba(255, 255, 255, 0.75);
            --sun-pos: 60%; --moon-pos: 150%;
            --sun-opacity: 0.8; --moon-opacity: 0;
        }

        /* üåá Dusk */
        body[data-theme="dusk"] {
            --bg-grad: linear-gradient(180deg, #355C7D 0%, #6C5B7B 50%, #C06C84 100%);
            --text: #2D3436; --text-sec: #636E72; --primary: #F8B195; --line: #A8A8A8;
            --card-bg: rgba(255, 255, 255, 0.7);
            --sun-pos: 80%; --moon-pos: 150%;
            --sun-opacity: 0.8; --moon-opacity: 0;
        }

        /* üåô Night */
        body[data-theme="night"] {
            --bg-grad: linear-gradient(180deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --text: #ECF0F1; --text-sec: #BDC3C7; --primary: #54A0FF; --line: #34495E;
            --card-bg: rgba(30, 40, 50, 0.6);
            --sun-pos: -50%; --moon-pos: 10%;
            --sun-opacity: 0; --moon-opacity: 1;
        }

        body {
            background-image: var(--bg-grad); color: var(--text);
            transition: background-image var(--transition-speed) ease-in-out, color 1s ease;
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* --- Canvas & Celestial --- */
        #world-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }
        .celestial-container { 
            position: fixed; width: 200px; height: 200px; 
            z-index: 1; pointer-events: none; 
            transition: top var(--transition-speed) cubic-bezier(0.34, 1.56, 0.64, 1), opacity var(--transition-speed) ease;
            right: 5%;
        }

        /* --- UI Components --- */
        header { z-index: 50; background: transparent; border-bottom: 1px solid transparent; transition: all 1s; }
        .fab-btn { z-index: 40; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .fab-btn:hover { transform: scale(1.1) rotate(15deg); }

        .modal-overlay { z-index: 9999; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); }
        .modal-content { 
            background-color: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--line); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            position: relative; z-index: 10000;
            transition: background-color 3s ease;
        }

        /* Editor Image Constraint Fix */
        #editor-content img {
            max-height: 100px; width: auto;
            border-radius: 6px; display: inline-block; margin: 4px 8px 4px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: default; vertical-align: middle;
        }

        /* Entry Card (Timeline Item) */
        .entry-card {
            background-color: var(--card-bg); border: 1px solid var(--line);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease; cursor: pointer; border-radius: 12px; z-index: 10; position: relative;
            backdrop-filter: blur(5px);
            display: flex; flex-direction: row; align-items: flex-start;
        }
        .entry-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .entry-card:active { transform: scale(0.99); }

        /* Fixed Thumbnail Box for Timeline */
        .thumb-box {
            width: 5rem; height: 5rem; flex-shrink: 0; 
            margin-left: 1rem; /* Fixed spacing from text */
            border-radius: 6px; overflow: hidden;
            border: 1px solid var(--line); background: rgba(0,0,0,0.05);
            box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
        }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }

        /* Calendar */
        .calendar-cell {
            aspect-ratio: 1/1; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Lato', sans-serif; font-size: 0.9rem;
            transition: all 0.2s; cursor: pointer; user-select: none;
            position: relative; color: var(--text);
        }
        .calendar-cell:hover { background-color: var(--line); opacity: 0.8; }
        .calendar-cell.has-entry::after {
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px;
            background-color: var(--primary); border-radius: 50%;
            box-shadow: 0 0 4px var(--primary);
        }

        /* Archive List */
        .archive-row {
            display: flex; align-items: center; gap: 1rem; padding: 1rem;
            border-bottom: 1px solid var(--line);
            background: rgba(255,255,255,0.1);
            transition: background 0.2s;
        }
        .archive-row:hover { background: rgba(255,255,255,0.25); }
        
        /* Utils */
        .hidden-view { display: none !important; }
        .active-view { display: block !important; animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Tabs */
        .nav-btn {
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 0.85rem; letter-spacing: 0.1em;
            padding-bottom: 0.5rem; transition: all 0.3s ease; position: relative;
        }
        .nav-btn-active { opacity: 1 !important; color: var(--text); border-bottom: 2px solid var(--text) !important; }
        .nav-btn-inactive { opacity: 0.5; color: var(--text); border-bottom: 2px solid transparent; }
        .nav-btn-inactive:hover { opacity: 0.8; }

        /* AI Report */
        .ai-section { margin-bottom: 1.5rem; border-bottom: 1px dashed var(--line); padding-bottom: 1rem; }
        .ai-title { font-family: 'Ma Shan Zheng', cursive; font-weight: bold; color: var(--primary); margin-bottom: 0.5rem; font-size: 1.4em; }

        .sketch-stroke { fill: none; stroke: currentColor; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body data-theme="day" class="antialiased h-screen overflow-hidden flex flex-col selection:bg-[var(--primary)] selection:text-white">

    <!-- Particle Canvas -->
    <canvas id="world-canvas"></canvas>

    <!-- Celestial Bodies -->
    <div id="sun-container" class="celestial-container text-yellow-400 mix-blend-screen" style="top: var(--sun-pos); opacity: var(--sun-opacity);">
        <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_30px_rgba(253,224,71,0.6)]">
             <circle cx="100" cy="100" r="40" fill="currentColor" class="opacity-90" />
             <g class="sketch-stroke opacity-60">
                 <line x1="100" y1="40" x2="100" y2="20" />
                 <line x1="100" y1="160" x2="100" y2="180" />
                 <line x1="40" y1="100" x2="20" y2="100" />
                 <line x1="160" y1="100" x2="180" y2="100" />
                 <line x1="58" y1="58" x2="44" y2="44" />
                 <line x1="142" y1="142" x2="156" y2="156" />
                 <line x1="58" y1="142" x2="44" y2="156" />
                 <line x1="142" y1="58" x2="156" y2="44" />
             </g>
        </svg>
    </div>
    <div id="moon-container" class="celestial-container text-gray-200 mix-blend-screen" style="top: var(--moon-pos); opacity: var(--moon-opacity);">
        <svg viewBox="0 0 200 200" class="w-full h-full drop-shadow-[0_0_20px_rgba(255,255,255,0.4)]">
            <path d="M140 40 C 100 40, 60 80, 60 120 C 60 150, 80 175, 110 185 C 80 170, 75 130, 75 100 C 75 70, 100 50, 140 40" fill="currentColor" />
            <circle cx="120" cy="100" r="2" fill="#94a3b8" class="opacity-50" />
            <circle cx="100" cy="140" r="3" fill="#94a3b8" class="opacity-30" />
            <circle cx="90" cy="90" r="1.5" fill="#94a3b8" class="opacity-40" />
        </svg>
    </div>

    <!-- Header -->
    <header class="fixed top-0 w-full">
        <div class="max-w-4xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3 group cursor-default">
                <div class="w-10 h-10 rounded-full border-2 border-[var(--text)] flex items-center justify-center text-[var(--text)] group-hover:rotate-180 transition-transform duration-700">
                    <i data-lucide="hourglass" class="w-5 h-5"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-[0.2em] font-display uppercase text-[var(--text)] drop-shadow-sm">Timeline</h1>
            </div>
            <div class="flex gap-12">
                <button onclick="UI.switchView('timeline')" id="btn-timeline" class="nav-btn nav-btn-active">TIMELINE</button>
                <button onclick="UI.switchView('calendar')" id="btn-calendar" class="nav-btn nav-btn-inactive">CALENDAR</button>
            </div>
            <div class="flex gap-3">
                 <button onclick="UI.openWeeklySummary()" class="p-2 hover:bg-[var(--line)] rounded-full text-[var(--text)] transition-colors" title="The Oracle"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar pt-28 pb-32 scroll-smooth relative z-10" id="main-container">
        <div class="max-w-4xl mx-auto px-4 relative min-h-screen">
            
            <!-- TIMELINE VIEW -->
            <div id="view-timeline" class="active-view relative">
                <div class="timeline-line border-l-2 border-[var(--line)] opacity-40 border-dashed"></div>
                <div id="diary-list" class="space-y-12 pb-24 relative z-10"></div>
                <div class="text-center py-12 opacity-60 font-display tracking-[0.3em] text-xs text-[var(--text)] italic">~ END OF CHRONICLE ~</div>
            </div>

            <!-- CALENDAR VIEW -->
            <div id="view-calendar" class="hidden-view pb-24">
                <!-- Calendar Card -->
                <div class="bg-[var(--card-bg)] rounded-2xl p-8 shadow-xl border border-[var(--line)]/50 backdrop-blur-lg">
                    <div class="flex justify-between items-center mb-8 border-b border-[var(--line)] pb-6">
                        <button onclick="UI.changeMonth(-1)" class="p-3 hover:bg-[var(--line)] rounded-full transition-colors"><i data-lucide="chevron-left" class="w-6 h-6 text-[var(--text)]"></i></button>
                        <div class="text-center">
                            <h2 class="text-5xl font-display font-bold text-[var(--primary)] mb-1 drop-shadow-sm" id="cal-month-display">Nov</h2>
                            <div class="text-xl font-num text-[var(--text-sec)] tracking-widest" id="cal-year-display">2025</div>
                        </div>
                        <button onclick="UI.changeMonth(1)" class="p-3 hover:bg-[var(--line)] rounded-full transition-colors"><i data-lucide="chevron-right" class="w-6 h-6 text-[var(--text)]"></i></button>
                    </div>
                    <div class="grid grid-cols-7 gap-4 text-center mb-4 text-xs font-bold font-num text-[var(--text-sec)] uppercase tracking-widest">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="grid grid-cols-7 gap-4" id="calendar-grid"></div>
                </div>

                <!-- Archive List -->
                <div class="mt-10">
                    <div class="flex justify-between items-end mb-4 border-b border-[var(--line)] pb-2 px-2">
                        <h3 class="font-display text-xl font-bold text-[var(--text)] flex items-center gap-2">
                            <i data-lucide="folder-open" class="w-5 h-5 text-[var(--primary)]"></i> Monthly Archive
                        </h3>
                        <button onclick="EntryManager.exportMonthMarkdown()" class="text-[10px] font-bold font-num bg-[var(--primary)] text-white px-4 py-1.5 rounded-full shadow hover:shadow-md transition-all uppercase tracking-wide">
                            Export MD
                        </button>
                    </div>
                    <div id="month-entries" class="space-y-3"></div>
                    <div id="month-empty-state" class="hidden text-center py-16 text-[var(--text-sec)]">
                        <i data-lucide="wind" class="w-10 h-10 mx-auto mb-3 opacity-40"></i>
                        <p class="italic opacity-70">The winds of time have left no trace here.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FAB -->
    <button onclick="UI.openEditor()" class="fab-btn fixed bottom-10 right-8 w-16 h-16 bg-[var(--primary)] text-white rounded-full shadow-2xl flex items-center justify-center border-4 border-[rgba(255,255,255,0.2)] backdrop-blur-sm">
        <i data-lucide="pen-tool" class="w-7 h-7"></i>
    </button>

    <!-- Dialog Modal -->
    <div id="dialog-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4 z-[10001]">
        <div class="bg-[var(--card-bg)] w-full max-w-sm rounded-2xl shadow-2xl border border-[var(--line)] p-8 text-center relative">
            <div id="dialog-icon" class="mb-4 flex justify-center text-[var(--primary)]"></div>
            <h3 id="dialog-title" class="font-display font-bold text-2xl mb-2 text-[var(--text)]"></h3>
            <p id="dialog-msg" class="text-[var(--text-sec)] text-sm mb-8 font-serif leading-relaxed"></p>
            <div class="flex justify-center gap-4" id="dialog-actions"></div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="editor-modal" class="modal-overlay fixed inset-0 hidden">
        <div class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity" onclick="UI.closeEditor()"></div>
        <div class="modal-content absolute bottom-0 left-0 w-full sm:max-w-2xl sm:left-1/2 sm:-translate-x-1/2 sm:bottom-6 rounded-t-3xl sm:rounded-2xl p-8 shadow-2xl transform translate-y-full transition-transform duration-500 border border-[var(--line)] flex flex-col max-h-[85vh]" id="editor-panel">
            <div class="flex justify-between items-center mb-6 border-b border-[var(--line)]/50 pb-4">
                <div class="flex items-center gap-3">
                    <input type="date" id="editor-date" class="bg-transparent font-num text-sm outline-none text-[var(--text)] border border-[var(--line)] rounded-md px-3 py-1.5 hover:border-[var(--primary)] transition-colors">
                    <input type="time" id="editor-time" class="bg-transparent font-num text-sm outline-none text-[var(--text)] border border-[var(--line)] rounded-md px-3 py-1.5 hover:border-[var(--primary)] transition-colors">
                </div>
                <button onclick="EntryManager.saveFromEditor()" class="bg-[var(--primary)] text-white px-6 py-2 rounded-full font-bold font-num text-xs shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all tracking-wide">SAVE MEMORY</button>
            </div>
            
            <input type="hidden" id="editor-id">

            <div class="flex gap-6 mb-6 overflow-x-auto pb-2 no-scrollbar items-center">
                <div class="flex gap-2 p-1.5 bg-[var(--line)]/20 rounded-lg border border-[var(--line)]/30 shrink-0">
                    <button onclick="UI.selectMood('smile')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="mood-smile"><i data-lucide="smile" class="w-5 h-5"></i></button>
                    <button onclick="UI.selectMood('meh')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="mood-meh"><i data-lucide="meh" class="w-5 h-5"></i></button>
                    <button onclick="UI.selectMood('frown')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="mood-frown"><i data-lucide="frown" class="w-5 h-5"></i></button>
                    <button onclick="UI.selectMood('heart')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="mood-heart"><i data-lucide="heart" class="w-5 h-5"></i></button>
                </div>
                <div class="flex gap-2 p-1.5 bg-[var(--line)]/20 rounded-lg border border-[var(--line)]/30 shrink-0">
                    <button onclick="UI.selectWeather('sun')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="weather-sun"><i data-lucide="sun" class="w-5 h-5"></i></button>
                    <button onclick="UI.selectWeather('cloud')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="weather-cloud"><i data-lucide="cloud" class="w-5 h-5"></i></button>
                    <button onclick="UI.selectWeather('rain')" class="selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors" id="weather-rain"><i data-lucide="cloud-rain" class="w-5 h-5"></i></button>
                </div>
            </div>
            <input id="editor-title" type="text" placeholder="Title of your story..." class="w-full bg-transparent text-3xl font-bold mb-4 outline-none placeholder-[var(--text-sec)]/30 text-[var(--text)] font-display border-b border-transparent focus:border-[var(--line)] pb-2 transition-colors">
            
            <div id="editor-content" contenteditable="true" class="flex-1 w-full outline-none text-lg leading-loose text-[var(--text)] font-serif overflow-y-auto min-h-[200px] p-4 border border-[var(--line)]/30 focus:border-[var(--line)] rounded-xl transition-colors bg-[var(--bg)]/10" placeholder="What happened today?"></div>
            
            <div class="flex gap-2 mt-4 pt-2 border-t border-[var(--line)]/30">
                 <button class="toolbar-btn hover:bg-[var(--line)]/20 p-2 rounded" onmousedown="event.preventDefault(); UI.execCmd('bold')"><i data-lucide="bold" class="w-4 h-4"></i></button>
                <button class="toolbar-btn hover:bg-[var(--line)]/20 p-2 rounded" onmousedown="event.preventDefault(); UI.execCmd('italic')"><i data-lucide="italic" class="w-4 h-4"></i></button>
                <button class="toolbar-btn hover:bg-[var(--line)]/20 p-2 rounded" onmousedown="event.preventDefault(); UI.execCmd('insertUnorderedList')"><i data-lucide="list" class="w-4 h-4"></i></button>
                <div class="w-px bg-[var(--line)] mx-2 h-6 self-center"></div>
                <button class="toolbar-btn text-[var(--primary)] hover:bg-[var(--primary)]/10 p-2 rounded" onmousedown="event.preventDefault(); UI.triggerImageUpload()"><i data-lucide="image" class="w-4 h-4"></i></button>
            </div>
            <input type="file" id="image-input" accept="image/*" class="hidden" onchange="UI.handleImageUpload(this)">
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="UI.closeDetail()"></div>
        <div class="bg-[var(--card-bg)] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden relative z-50 flex flex-col max-h-[90vh] border border-[var(--line)]">
            <div class="p-10 overflow-y-auto no-scrollbar flex-1">
                <div class="flex justify-between items-start mb-8 border-b border-[var(--line)]/50 pb-6">
                    <div>
                        <h2 class="text-4xl font-bold font-display text-[var(--text)] leading-tight drop-shadow-sm" id="detail-title"></h2>
                        <div class="flex gap-4 mt-3 font-num text-sm text-[var(--text-sec)] tracking-widest items-center uppercase">
                            <span id="detail-date"></span> <span class="text-[var(--line)]">|</span> <span id="detail-time" class="text-[var(--primary)] font-bold"></span>
                            <div id="detail-meta" class="flex gap-3 ml-2 opacity-80 bg-[var(--line)]/20 px-3 py-1 rounded-full"></div>
                        </div>
                    </div>
                    <button onclick="UI.closeDetail()" class="p-2 hover:bg-[var(--line)] rounded-full text-[var(--text-sec)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div id="detail-content" class="text-xl leading-loose text-[var(--text)] font-serif prose prose-lg max-w-none"></div>
            </div>
            
            <div class="p-6 border-t border-[var(--line)] bg-[var(--bg)]/30 flex justify-end gap-4 backdrop-blur-sm">
                <button onclick="UI.editCurrentEntry()" class="flex items-center gap-2 px-6 py-2.5 bg-white/50 border border-[var(--line)] rounded-full text-xs font-bold text-[var(--text)] hover:text-[var(--primary)] hover:border-[var(--primary)] uppercase tracking-widest transition-all shadow-sm">
                    <i data-lucide="edit" class="w-3 h-3"></i> Edit
                </button>
                <button onclick="UI.deleteCurrentEntry()" class="flex items-center gap-2 px-6 py-2.5 bg-red-50/50 border border-red-200 rounded-full text-xs font-bold text-red-500 hover:bg-red-500 hover:text-white uppercase tracking-widest transition-all shadow-sm">
                    <i data-lucide="trash" class="w-3 h-3"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- AI Summary Modal (Fortune Teller) -->
    <div id="summary-modal" class="modal-overlay fixed inset-0 hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="UI.closeWeeklySummary()"></div>
        <div class="bg-[var(--card-bg)] w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-50 border border-[var(--line)]" id="summary-card">
            <div class="h-48 bg-[var(--primary)] relative overflow-hidden flex items-center px-10">
                 <div class="absolute inset-0 opacity-30 mix-blend-multiply bg-[url('https://www.transparenttextures.com/patterns/aged-paper.png')]"></div>
                 <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/30"></div>
                <div class="text-white z-10 relative w-full">
                    <div class="text-xs font-num opacity-80 uppercase tracking-[0.3em] mb-2">Oracle Insights</div>
                    <h2 class="text-4xl font-display font-bold drop-shadow-md">ÂëΩËøêÊåáÂºï</h2>
                    <button onclick="UI.closeWeeklySummary()" class="absolute top-0 right-0 text-white/70 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            <div class="p-8 text-[var(--text)] max-h-[60vh] overflow-y-auto space-y-6 scroll-smooth">
                
                <!-- Config Section -->
                <div id="fortune-config" class="mb-4">
                    <div class="p-4 bg-[var(--bg)]/50 border border-[var(--line)] rounded-xl space-y-3">
                        <div>
                             <label class="block text-[10px] font-bold text-[var(--text-sec)] uppercase tracking-wider mb-1">‰Ω†ÁöÑÊòüÂ∫ß (Zodiac)</label>
                             <input type="text" id="user-zodiac" class="w-full bg-white/80 p-2 px-3 border border-[var(--line)] text-sm rounded-lg focus:ring-1 focus:ring-[var(--primary)] outline-none" placeholder="‰æãÂ¶Ç: Â§©ËùéÂ∫ß / Scorpio">
                        </div>
                        <div>
                             <label class="block text-[10px] font-bold text-[var(--text-sec)] uppercase tracking-wider mb-1">ÂÖ´Â≠ó/ÁîüÊó• (BaZi/DOB)</label>
                             <input type="text" id="user-bazi" class="w-full bg-white/80 p-2 px-3 border border-[var(--line)] text-sm rounded-lg focus:ring-1 focus:ring-[var(--primary)] outline-none" placeholder="‰æãÂ¶Ç: 1995Âπ¥5Êúà20Êó• Êó©‰∏ä8ÁÇπ">
                        </div>
                        <div class="pt-2 flex gap-2">
                             <button onclick="UI.saveProfileAndAnalyze()" class="flex-1 bg-[var(--primary)] text-white px-4 py-2 text-sm font-bold rounded-lg shadow hover:bg-opacity-90 transition-all flex items-center justify-center gap-2">
                                 <i data-lucide="sparkles" class="w-4 h-4"></i> ÂºÄÂßãËß£ËØª
                             </button>
                        </div>
                    </div>
                    <!-- API Key (Hidden by default unless empty) -->
                     <div class="mt-4 text-center">
                         <input type="password" id="user-api-key" class="text-xs text-center bg-transparent border-b border-[var(--line)] outline-none w-1/2 opacity-50 hover:opacity-100 transition-opacity" placeholder="API Key (Optional)">
                     </div>
                </div>

                <div id="summary-ai-content" class="space-y-6 text-sm leading-relaxed font-serif opacity-90">
                    <div class="text-center text-[var(--text-sec)] italic py-4">
                        ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊòüÂ∫ßÊàñÁîüÊó•ÔºåËÆ© AI ÁªìÂêàÊó•ËÆ∞‰∏∫ÊÇ®Êè≠Á§∫ËøêÂäø„ÄÇ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_API_KEY = "AIzaSyDjPO6FOcgwrWWVXfovoqsmIJD4xaeUiXE";

        // --- Particle System ---
        const ParticleSystem = {
            canvas: null, ctx: null, particles: [], width: 0, height: 0, theme: 'day', running: false,
            init: function() {
                this.canvas = document.getElementById('world-canvas'); this.ctx = this.canvas.getContext('2d');
                this.resize(); window.addEventListener('resize', () => this.resize());
                this.createParticles(); this.running = true; this.animate();
            },
            resize: function() {
                this.width = window.innerWidth; this.height = window.innerHeight;
                this.canvas.width = this.width; this.canvas.height = this.height;
            },
            createParticles: function() {
                this.particles = []; const count = this.width < 600 ? 20 : 40;
                for(let i=0; i<count; i++) this.particles.push(new Particle(this.width, this.height));
            },
            setTheme: function(theme) { this.theme = theme; },
            animate: function() {
                if(!this.running) return;
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.particles.forEach(p => { p.update(this.width, this.height, this.theme); p.draw(this.ctx, this.theme); });
                requestAnimationFrame(() => this.animate());
            }
        };

        class Particle {
            constructor(w, h) { this.init(w, h); }
            init(w, h) {
                this.x = Math.random() * w; this.y = Math.random() * h;
                this.size = Math.random() * 2 + 1;
                this.speedX = (Math.random() - 0.5) * 0.2; this.speedY = (Math.random() - 0.5) * 0.2;
                this.opacity = Math.random() * 0.5 + 0.1; this.blinkPhase = Math.random() * Math.PI * 2;
                this.twinkleSpeed = Math.random() * 0.03 + 0.005;
                this.angle = -30 * (Math.PI / 180); this.rayLength = Math.random() * 400 + 200; this.rayWidth = Math.random() * 40 + 10;
            }
            update(w, h, theme) {
                if (theme === 'night') { this.blinkPhase += this.twinkleSpeed; } 
                else {
                    this.x += this.speedX; this.y += this.speedY;
                    if(this.x < -200) this.x = w + 200; if(this.x > w + 200) this.x = -200;
                    if(this.y < -200) this.y = h + 200; if(this.y > h + 200) this.y = -200;
                }
            }
            draw(ctx, theme) {
                if (theme === 'night') {
                    let opacity = (Math.sin(this.blinkPhase) + 1) / 2 * 0.8; 
                    ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 0.8, 0, Math.PI * 2); ctx.fill();
                } else if (theme === 'day') {
                    ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle);
                    let grad = ctx.createLinearGradient(0, 0, this.rayLength, 0);
                    grad.addColorStop(0, `rgba(255, 255, 255, 0)`);
                    grad.addColorStop(0.2, `rgba(255, 255, 255, 0.08)`);
                    grad.addColorStop(0.8, `rgba(255, 255, 255, 0.08)`);
                    grad.addColorStop(1, `rgba(255, 255, 255, 0)`);
                    ctx.fillStyle = grad; ctx.fillRect(0, -this.rayWidth/2, this.rayLength, this.rayWidth); ctx.restore();
                } else {
                    ctx.beginPath(); ctx.fillStyle = `rgba(255, 220, 150, 0.3)`;
                    ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2); ctx.fill();
                }
            }
        }

        // --- Database Layer ---
        const EntryManager = {
            data: [],
            init: function() {
                try {
                    const stored = localStorage.getItem('timeline_entries');
                    this.data = stored ? JSON.parse(stored) : [];
                    if (this.data.length === 0) {
                        this.add({
                            title: "A New Beginning",
                            content: "Welcome to your timeline. The journey starts here.",
                            mood: "smile", weather: "sun",
                            ts: Date.now(), h: 12, m: 0
                        });
                    }
                } catch(e) { console.error("DB Init failed", e); this.data = []; }
            },
            saveToDisk: function() { localStorage.setItem('timeline_entries', JSON.stringify(this.data)); UI.refreshAll(); },
            getAll: function() { return this.data; },
            getById: function(id) { return this.data.find(e => String(e.id) === String(id)); },
            add: function(entry) { entry.id = Date.now(); this.data.unshift(entry); this.saveToDisk(); return entry; },
            update: function(id, updates) { const idx = this.data.findIndex(e => String(e.id) === String(id)); if (idx !== -1) { this.data[idx] = { ...this.data[idx], ...updates }; this.saveToDisk(); } },
            delete: function(id) {
                const beforeCount = this.data.length; this.data = this.data.filter(e => String(e.id) !== String(id));
                if(this.data.length !== beforeCount) { this.saveToDisk(); return true; } return false;
            },
            saveFromEditor: function() {
                const id = document.getElementById('editor-id').value; const t = document.getElementById('editor-title').value;
                const c = document.getElementById('editor-content').innerHTML; const d = document.getElementById('editor-date').value;
                const tm = document.getElementById('editor-time').value; let thumb = null;
                const wrapper = document.createElement('div'); wrapper.innerHTML = c; const imgEl = wrapper.querySelector('img'); if(imgEl) thumb = imgEl.src;
                if(t && d && tm) {
                    const [y,m,day] = d.split('-').map(Number); const [hr,min] = tm.split(':').map(Number); const ts = new Date(y,m-1,day,hr,min).getTime();
                    const payload = { ts, h: hr, m: min, title: t, content: c, mood: UI.state.mood, weather: UI.state.weather, img: thumb };
                    if (id) { this.update(id, payload); } else { this.add(payload); } UI.closeEditor();
                } else { UI.showDialog('alert', 'Incomplete', 'Please fill in a Title and Date.', null); }
            },
            exportMonthMarkdown: function() {
                const y = UI.state.calendarDate.getFullYear(); const m = UI.state.calendarDate.getMonth();
                const entries = this.data.filter(e => { const d = new Date(e.ts); return d.getFullYear() === y && d.getMonth() === m; }).sort((a,b) => a.ts - b.ts);
                if(entries.length === 0) { UI.showDialog('alert', 'Empty', "No entries to export for this month.", null); return; }
                let md = `# Journal Archive - ${y}/${m+1}\n\n`;
                entries.forEach(e => {
                    const dt = new Date(e.ts); let content = e.content.replace(/<img[^>]*src="([^"]*)"[^>]*>/g, '![Image]($1)\n').replace(/<[^>]+>/g, ''); 
                    md += `## ${e.title}\n> ${dt.toLocaleString()} | Mood: ${e.mood}\n\n${content}\n\n---\n\n`;
                });
                const dataStr = "data:text/markdown;charset=utf-8," + encodeURIComponent(md); const dlNode = document.createElement('a');
                dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", `Journal_${y}_${m+1}.md`); document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
            }
        };

        // --- UI Layer ---
        const UI = {
            state: { mood: 'smile', weather: 'sun', calendarDate: new Date(), currentDetailId: null },
            init: function() {
                lucide.createIcons(); ParticleSystem.init(); this.refreshAll(); this.initThemeObserver();
                let k = localStorage.getItem('gemini_api_key');
                if(!k) { k = DEFAULT_API_KEY; localStorage.setItem('gemini_api_key', k); }
                document.getElementById('user-api-key').value = k;
                
                // Load User Profile
                const z = localStorage.getItem('user_zodiac'); if(z) document.getElementById('user-zodiac').value = z;
                const b = localStorage.getItem('user_bazi'); if(b) document.getElementById('user-bazi').value = b;
            },
            refreshAll: function() { this.renderTimeline(); this.renderCalendar(); },
            
            showDialog: function(type, title, msg, onConfirm) {
                const el = document.getElementById('dialog-modal');
                document.getElementById('dialog-title').innerText = title; document.getElementById('dialog-msg').innerText = msg;
                const actions = document.getElementById('dialog-actions'); actions.innerHTML = '';
                const icon = document.getElementById('dialog-icon');
                icon.innerHTML = type === 'confirm' ? '<i data-lucide="alert-triangle" class="w-10 h-10"></i>' : '<i data-lucide="info" class="w-10 h-10"></i>';
                const btnCancel = document.createElement('button');
                btnCancel.className = "px-5 py-2 rounded-full border border-[var(--line)] text-[var(--text)] text-xs font-bold hover:bg-[var(--line)] transition-colors";
                btnCancel.innerText = type === 'confirm' ? "CANCEL" : "CLOSE"; btnCancel.onclick = () => el.classList.add('hidden'); actions.appendChild(btnCancel);
                if(type === 'confirm') {
                    const btnOk = document.createElement('button');
                    btnOk.className = "px-5 py-2 rounded-full bg-red-500 text-white text-xs font-bold hover:bg-red-600 transition-colors shadow-lg";
                    btnOk.innerText = "DELETE";
                    btnOk.onclick = () => { if(onConfirm) onConfirm(); el.classList.add('hidden'); }; actions.appendChild(btnOk);
                }
                lucide.createIcons(); el.classList.remove('hidden');
            },
            switchView: function(v) {
                const tl = document.getElementById('view-timeline'); const cal = document.getElementById('view-calendar');
                const bt = document.getElementById('btn-timeline'); const bc = document.getElementById('btn-calendar');
                if(v === 'timeline') {
                    tl.classList.remove('hidden-view'); tl.classList.add('active-view'); cal.classList.remove('active-view'); cal.classList.add('hidden-view');
                    bt.classList.replace('nav-btn-inactive', 'nav-btn-active'); bc.classList.replace('nav-btn-active', 'nav-btn-inactive');
                } else {
                    tl.classList.remove('active-view'); tl.classList.add('hidden-view'); cal.classList.remove('hidden-view'); cal.classList.add('active-view');
                    bt.classList.replace('nav-btn-active', 'nav-btn-inactive'); bc.classList.replace('nav-btn-inactive', 'nav-btn-active'); this.renderCalendar(); 
                }
            },
            renderTimeline: function() {
                const container = document.getElementById('diary-list'); container.innerHTML = '';
                const entries = EntryManager.getAll().sort((a, b) => b.ts - a.ts);
                entries.forEach(item => {
                    const date = new Date(item.ts); const div = document.createElement('div');
                    div.className = `entry-item flex relative group`; div.dataset.hour = date.getHours();
                    const node = `<div class="absolute left-[5.3rem] sm:left-[8.85rem] top-6 w-3 h-3 rounded-full bg-[var(--primary)] border-4 border-[var(--bg)] z-20 shadow-sm"></div>`;
                    let thumb = item.img ? `<div class="thumb-box"><img src="${item.img}" class="thumb-img"></div>` : '';
                    const card = document.createElement('div'); card.className = `entry-card p-6 flex flex-row items-start flex-1`;
                    card.innerHTML = `<div class="flex-1 min-w-0"><h3 class="text-xl font-bold text-[var(--text)] font-display mb-2">${item.title}</h3><div class="text-base text-[var(--text)]/80 leading-relaxed font-serif line-clamp-3">${item.content.replace(/<[^>]*>/g, '')}</div></div>${thumb}`;
                    card.onclick = () => this.openDetail(item);
                    div.innerHTML = `<div class="date-col w-[5.5rem] sm:w-36 flex flex-col items-end pr-6 pt-2 shrink-0 z-10 text-right"><span class="text-4xl font-bold font-num text-[var(--text)]">${String(date.getDate()).padStart(2, '0')}</span><span class="text-[10px] font-num font-bold text-[var(--text-sec)] uppercase tracking-widest">${date.toLocaleString('default', {month:'short'})} ${date.getFullYear()}</span><div class="mt-2 text-xs font-bold text-[var(--primary)] font-num">${this.formatTime(date)}</div></div>${node}`;
                    const right = document.createElement('div'); right.className = 'flex-1 pl-8 pb-12'; right.appendChild(card); div.appendChild(right); container.appendChild(div);
                    if(this.themeObserver) this.themeObserver.observe(div);
                });
            },
            renderCalendar: function() {
                const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
                const y = this.state.calendarDate.getFullYear(), m = this.state.calendarDate.getMonth();
                document.getElementById('cal-month-display').innerText = new Date(y, m).toLocaleString('default', { month: 'short' });
                document.getElementById('cal-year-display').innerText = y;
                const fd = new Date(y, m, 1).getDay(), dim = new Date(y, m + 1, 0).getDate();
                const entries = EntryManager.getAll(); const monthEntries = [];
                for(let i=0; i<fd; i++) grid.appendChild(document.createElement('div'));
                for(let i=1; i<=dim; i++) {
                    const d = document.createElement('div'); d.className = 'calendar-cell'; d.textContent = i;
                    const dayEntries = entries.filter(e => { const t=new Date(e.ts); return t.getFullYear()===y && t.getMonth()===m && t.getDate()===i; });
                    if(dayEntries.length > 0) { d.classList.add('has-entry', 'font-bold', 'text-[var(--primary)]'); monthEntries.push(...dayEntries); }
                    d.onclick = (e) => { e.stopPropagation(); if (dayEntries.length > 0) this.openDetail(dayEntries[0]); else this.openEditor(`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`); };
                    grid.appendChild(d);
                }
                this.renderMonthList(monthEntries.sort((a, b) => b.ts - a.ts));
            },
            renderMonthList: function(entries) {
                const container = document.getElementById('month-entries'); const empty = document.getElementById('month-empty-state'); container.innerHTML = '';
                if(entries.length === 0) { container.style.display = 'none'; empty.style.display = 'block'; } 
                else {
                    container.style.display = 'block'; empty.style.display = 'none';
                    entries.forEach(e => {
                        const d = new Date(e.ts); const el = document.createElement('div'); el.className = 'archive-row rounded-lg cursor-pointer';
                        const summary = e.content.replace(/<[^>]*>/g, '').substring(0, 50) + '...';
                        el.innerHTML = `<div class="archive-date text-xl">${String(d.getDate()).padStart(2,'0')}</div><div class="archive-content"><div class="archive-title">${e.title}</div><div class="archive-preview">${summary}</div></div><button class="p-2 text-[var(--text-sec)] hover:text-red-500 transition-colors" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        el.onclick = () => this.openDetail(e); el.querySelector('button').onclick = (evt) => { evt.stopPropagation(); this.deleteEntryById(e.id); };
                        container.appendChild(el);
                    });
                }
                lucide.createIcons();
            },
            openDetailById: function(id) { const entry = EntryManager.getById(id); if(entry) this.openDetail(entry); },
            deleteEntryById: function(id) { this.showDialog('confirm', 'Delete Memory?', 'This will permanently erase this moment from time.', () => { const success = EntryManager.delete(id); if(!success) this.showDialog('alert', 'Error', 'Failed to delete item.', null); }); },
            deleteCurrentEntry: function() { if(this.state.currentDetailId) { const id = this.state.currentDetailId; this.closeDetail(); this.deleteEntryById(id); } },
            editCurrentEntry: function() { if (!this.state.currentDetailId) return; const entry = EntryManager.getById(this.state.currentDetailId); if(entry) { this.closeDetail(); const dt = new Date(entry.ts); this.openEditor(`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`, entry); } },
            openEditor: function(dStr=null, exist=null) {
                document.getElementById('editor-modal').classList.remove('hidden'); const now = new Date(); document.getElementById('editor-id').value = ""; 
                if(exist) {
                    document.getElementById('editor-id').value = exist.id; document.getElementById('editor-title').value = exist.title;
                    document.getElementById('editor-content').innerHTML = exist.content; const dt = new Date(exist.ts);
                    document.getElementById('editor-date').value = dStr; document.getElementById('editor-time').value = `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
                    this.selectMood(exist.mood || 'smile'); this.selectWeather(exist.weather || 'sun');
                } else {
                    document.getElementById('editor-title').value = ''; document.getElementById('editor-content').innerHTML = '';
                    document.getElementById('editor-date').value = dStr || now.toISOString().split('T')[0]; document.getElementById('editor-time').value = now.toTimeString().slice(0,5);
                    this.selectMood('smile'); this.selectWeather('sun');
                }
                void document.getElementById('editor-modal').offsetWidth; setTimeout(() => document.getElementById('editor-panel').classList.remove('translate-y-full'), 10);
            },
            closeEditor: function() { document.getElementById('editor-panel').classList.add('translate-y-full'); setTimeout(() => document.getElementById('editor-modal').classList.add('hidden'), 300); },
            openDetail: function(item) {
                this.state.currentDetailId = String(item.id); const m = document.getElementById('detail-modal'); const d = new Date(item.ts);
                document.getElementById('detail-title').innerText = item.title;
                document.getElementById('detail-date').innerText = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric'});
                document.getElementById('detail-time').innerText = this.formatTime(d);
                let html = item.content; if(item.img && html.indexOf(item.img) === -1) html = `<img src="${item.img}" class="w-full rounded-xl shadow-lg mb-8 sepia-[0.1]">` + html;
                document.getElementById('detail-content').innerHTML = html;
                document.getElementById('detail-meta').innerHTML = `<i data-lucide="${this.getMoodIcon(item.mood)}" class="w-4 h-4"></i> <span class="mx-2 text-[var(--line)]">|</span> <i data-lucide="${this.getWeatherIcon(item.weather)}" class="w-4 h-4"></i>`;
                lucide.createIcons(); m.classList.remove('hidden');
            },
            closeDetail: function() { document.getElementById('detail-modal').classList.add('hidden'); this.state.currentDetailId = null; },
            selectMood: function(m) { this.state.mood=m; this.updateSelectionUI(); },
            selectWeather: function(w) { this.state.weather=w; this.updateSelectionUI(); },
            updateSelectionUI: function() {
                 document.querySelectorAll('.selection-btn').forEach(b => { b.className = 'selection-btn p-2 rounded-md text-[var(--text-sec)] hover:bg-[var(--line)]/20 transition-colors'; });
                 const activeClass = 'selection-btn p-2 rounded-md bg-[var(--primary)] text-white shadow-md transform scale-105 transition-all';
                 const mBtn = document.getElementById(`mood-${this.state.mood}`); if(mBtn) mBtn.className = activeClass;
                 const wBtn = document.getElementById(`weather-${this.state.weather}`); if(wBtn) wBtn.className = activeClass;
            },
            execCmd: function(c) { document.execCommand(c, false, null); },
            triggerImageUpload: function() { document.getElementById('image-input').click(); },
            handleImageUpload: function(input) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { const editor = document.getElementById('editor-content'); editor.focus(); const imgHtml = `<br><img src="${e.target.result}" class="max-w-full rounded-lg shadow-md my-4 block"><br>`; document.execCommand('insertHTML', false, imgHtml) || (editor.innerHTML += imgHtml); }; reader.readAsDataURL(input.files[0]); input.value = ''; } },
            saveApiKey: function() { 
                const k = document.getElementById('user-api-key').value; localStorage.setItem('gemini_api_key', k); 
                this.showDialog('alert', 'Secure', 'API Key saved locally.', null);
            },
            
            // NEW: Save Profile & Analyze
            saveProfileAndAnalyze: function() {
                const z = document.getElementById('user-zodiac').value;
                const b = document.getElementById('user-bazi').value;
                const k = document.getElementById('user-api-key').value;
                
                if(z) localStorage.setItem('user_zodiac', z);
                if(b) localStorage.setItem('user_bazi', b);
                if(k) localStorage.setItem('gemini_api_key', k);
                
                this.generateReport();
            },

            openWeeklySummary: function() {
                document.getElementById('summary-modal').classList.remove('hidden');
                // Don't auto analyze, wait for user
            },

            generateReport: async function() {
                const div = document.getElementById('summary-ai-content');
                const k = localStorage.getItem('gemini_api_key') || document.getElementById('user-api-key').value;
                const zodiac = localStorage.getItem('user_zodiac') || "Êú™Êèê‰æõ";
                const bazi = localStorage.getItem('user_bazi') || "Êú™Êèê‰æõ";

                if(!k) { div.innerHTML = `<div class="text-center text-red-500">Please enter API Key above.</div>`; return; }

                div.innerHTML = `<div class="flex flex-col items-center py-10 space-y-3"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[var(--primary)]"></i><span class="text-xs opacity-60">ËßÇÊòüË±°ÔºåÊµãÂëΩÁêÜ...</span></div>`; lucide.createIcons();

                const recent = EntryManager.getAll().slice(0,7).map(e=>({ d:new Date(e.ts).toLocaleDateString(), t:e.title, c:e.content.replace(/<[^>]*>/g,'').substring(0,100) }));
                
                // CHINESE PROMPT WITH FORTUNE TELLING
                const prompt = `ËßíËâ≤Ôºö‰Ω†ÊòØ‰∏Ä‰Ωç‰∏ì‰∏öÁöÑÊó•ËÆ∞ÂàÜÊûêÂ∏àÂíåÁ≤æÈÄöÂë®ÊòìÂÖ´Â≠óÁöÑÂëΩÁêÜÂ§ßÂ∏à„ÄÇ
‰ªªÂä°ÔºöÂàÜÊûê‰ª•‰∏ãÊó•ËÆ∞ÂÜÖÂÆπÔºåÂπ∂ÁªìÂêàÁî®Êà∑ÁöÑÊòüÂ∫ßÂíåÂÖ´Â≠óÔºàÂ¶ÇÊûúÊúâÔºâËøõË°åËøêÂäøÈ¢ÑÊµã„ÄÇ
ËæìÂá∫Ê†ºÂºèÔºöHTML (divs with classes: ai-section, ai-title, ai-text)„ÄÇ‰∏çË¶ÅÂåÖÂê´ markdown ‰ª£Á†ÅÂùóÊ†áËÆ∞„ÄÇ
ÂÜÖÂÆπÊùøÂùóÔºö
1. üìú Êó∂ÂÖâÂõûÊ∫Ø (Narrative): Áî®‰ºòÁæéÁöÑ‰∏≠ÊñáÊÄªÁªìËøôÊÆµÊó∂Èó¥ÁöÑÁªèÂéÜÂíåÊïÖ‰∫ã„ÄÇ
2. üìä ÂøÉÊÉÖÊ∞îË±° (Mood Analysis): ÂàÜÊûêÊÉÖÁª™ÂèòÂåñË∂ãÂäø„ÄÇ
3. üîÆ ËøêÂäøÊåáÂºï (Guidance & Fortune):
   - Âü∫‰∫éÊó•ËÆ∞ÂÜÖÂÆπÁªôÂá∫Âª∫ËÆÆ„ÄÇ
   - Áî®Êà∑ÊòüÂ∫ß: ${zodiac}ÔºåÁî®Êà∑ÂÖ´Â≠ó: ${bazi}„ÄÇËØ∑ÁªìÂêàËøô‰∫õÂëΩÁêÜ‰ø°ÊÅØËøõË°åÂÖ∑‰ΩìÁöÑËøêÂäøÂç†ÂçúÔºàÁªìÂêàÂë®Êòì/ÊòüÁõòÔºâ„ÄÇ
   - Â¶ÇÊûúÊ≤°ÊúâÊèê‰æõÊòüÂ∫ß/ÂÖ´Â≠óÔºåËØ∑ÁªôÂá∫ÈÄöÁî®ÁöÑÂì≤Â≠¶ÊåáÂºï„ÄÇ

Áî®Êà∑Êó•ËÆ∞Êï∞ÊçÆ: ${JSON.stringify(recent)}`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
                    const json = await res.json();
                    if (json.candidates?.[0]?.content) div.innerHTML = json.candidates[0].content.parts[0].text.replace(/```html/g,'').replace(/```/g,'');
                    else div.innerText = "The Oracle is silent.";
                } catch(e) { div.innerHTML = "Connection Error. Check API Key."; }
            },

            closeWeeklySummary: () => document.getElementById('summary-modal').classList.add('hidden'),
            formatTime: (date) => { let h=date.getHours(), m=date.getMinutes(), ampm=h>=12?'PM':'AM'; h=h%12; h=h?h:12; m=m<10?'0'+m:m; return h+':'+m+' '+ampm; },
            getMoodIcon: (m) => ({smile:'smile',meh:'meh',frown:'frown',heart:'heart'}[m]||'smile'),
            getWeatherIcon: (w) => ({sun:'sun',cloud:'cloud',rain:'cloud-rain'}[w]||'sun'),
            
            initThemeObserver: function() {
                const scrollContainer = document.getElementById('main-container');
                this.themeObserver = new IntersectionObserver((entries) => {
                    entries.forEach(e => { if(e.isIntersecting) this.updateTheme(parseInt(e.target.dataset.hour)); });
                }, { root: scrollContainer, rootMargin: '-45% 0px -45% 0px', threshold: 0 });
            },
            updateTheme: (h) => {
                let theme = 'night';
                if (h >= 5 && h < 8) theme = 'dawn';
                else if (h >= 8 && h < 17) theme = 'day';
                else if (h >= 17 && h < 20) theme = 'dusk';
                document.body.setAttribute('data-theme', theme);
                ParticleSystem.setTheme(theme);
            }
        };

        window.onload = () => { EntryManager.init(); UI.init(); };
    </script>
</body>
</html>
